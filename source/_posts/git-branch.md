title: "Git 分支管理流程"
date: 2015-08-31 22:31:51
updated: 2016-01-03 22:31:51
tags: Git
---

项目总归要协作开发，在此介绍团队中常用的分支流程。

# 分支管理流程

企业的项目开发不像开源的项目开发，通常只会有一个远程仓库。这种情况下，通常会有两个常驻分支：

|分支名|描述|
|---|---|
|`master`|主干分支，仅用于发布新版本，平时不能在上面干活，只做代码合并。|
|`dev`|开发分支，平时干活的地方。每当发版时，需要被合并到 `master`，并且打标记（`git tag`）。|

一般来说，这样的分支也够用了。

## 创建特性分支

除了常驻分支，通常大的特性开发或缺陷修复还建议创建相应的临时分支。因为：

1. 在分支上开发可以让你随意尝试，进退自如，比如碰上无法正常工作的特性或补丁，可以先搁在那边，直到有时间仔细核查修复为止。
2. 团队中如果有代码审查流程，独立的分支还可以留给审查者抽空审查和改进代码的余地，并将是否合并、是否发布的权利留给审查者，为代码质量设一道门槛。

那么如何命名这类分支？可以用相关的主题关键字来命名，并且建议把分支名称分置于不同**命名空间**下，例如：

|命名空间|描述|
|---|---|
|`feature-*`|特性分支，为了开发某种特定功能而建。从 `dev` 分支分出来，开发完成后再并回 `dev`。|
|`bugfix-*`|缺陷分支，一般命名为 `bugfix-<issue 编号>`。软件正式发布以后，难免会出现 bug。这时就需要创建一个分支，进行 bug 修补。`bugfix-*` 分支是从 `master` 分支上面分出来的。修补结束以后，再合并进 `master` 和 `dev` 分支。|
|`refactor-*`|重构分支，为了进行某项功能重构、或者某个类的重构而建。从 `dev` 分支分出来，开发完成后再并回 `dev`。|

那么，开始创建第一个分支：

```bash
$ git checkout -b feature-cache

do something and commit...

$ git push origin feature-cache
```

### 定期合并

特性分支需要定期维护，主要的工作就是将主干合并（`merge`）进来。注意，如果该分支是多人开发，严禁使用 `rebase` 进行衍合，这会导致他人本地仓库的提交与远程仓库的发生冲突，导致无法正常推送。

### 决断代码

特性分支开发完成之后，我们想要筛选并看清将要合并到主干的是哪些代码，从而理解它们到底做了些什么，是否真的要并入。可以用 `--not` 选项屏蔽 `master` 分支，这样就会剔除重复的提交历史，看起来更清晰：

```bash
$ git log feature-cache --not master
```

或者相反，使用 `..` 参数查看将要被合并到主干的提交：

```bash
$ git log master..feature-cache
```

两者效果一致。

## 合并特性分支

现在，是时候将分支合并回主干，以便发布新版本了：

```bash
$ git checkout master
$ git merge --no-ff feature-cache
```

注意，为了保证版本演进的清晰，分支合并回主干的操作建议加上 `--no-ff` 参数进行非快进式合并（no-fast-forward merge），以便保留合并痕迹。合并后的祖先图谱如下：

```
*   ab900eb - 合并版本（注意这里！）
|\
| * 756ba83 - 特性分支版本2
| * 915fe84 - 特性分支版本1
|/
*   e7ce3f8 - master 基准版本（祖先）
```

可以看见，合并后保留有分支历史痕迹，能看得出来曾经做过分支合并。为了保证版本演进的清晰，当分支合并到主干时，推荐使用！

同时作为对比，如果不加上 `--no-ff` 参数，合并后的祖先图谱如下：

```
*   756ba83 - 特性分支版本2（SHA-1 不变）
|
*   915fe84 - 特性分支版本1（SHA-1 不变）
|
*   e7ce3f8 - master 基准版本（祖先）
```

那么，究竟什么是快进式合并（fast-forward merge）？如果顺着一个分支走下去可以直接到达另一个分支的话，那么 Git 在合并两者时，只会简单地把指针右移，因为这种单线的历史分支不存在任何需要解决的分歧，所以这种合并过程可以称为快进（Fast forward））。

## 标记新版本

版本发布之后，应该标记该新版本，以便后续回顾：

```bash
$ git tag v1.0 -m "XX 项目 v1.0 版本"
$ git push origin v1.0
```

注意，在默认情况下，`git push` 并不会把标签（tag）推送到远端仓库上，只有通过显式命令才能分享标签到远端仓库。其命令格式如同推送分支，运行 `git push origin [tagname]` 即可。如果要一次推送所有本地新增的标签上去，可以使用 `--tags` 选项。

## 删除特性分支

最后是一些清理工作，删除已开发完成的分支，避免分支越来越多导致不好管理：

```bash
$ git branch -d feature-cache
$ git push --delete origin feature-cache
```

# 总结

## 代码提交指南

* 请不要在更新中提交多余的白字符（whitespace）。Git 有种检查此类问题的方法，在提交之前，先运行 `git diff --check` ，会把可能的多余白字符修正列出来。
* 请将每次提交限定于完成一次逻辑功能。并且可能的话，适当地分解为多次小更新，以便每次小型提交都更易于理解。
* 最后需要谨记的是提交说明的撰写。可以理解为第一行的简要描述将用作邮件标题，其余部分作为邮件正文。

## 分支管理指南

* master 不提交代码，只合并代码。
* 合并代码到 master 的操作，由项目对应的集成管理员专人负责。
* 各分支要定期将 master 代码合并进来，避免后续分支合并到 master 时容易产生冲突，以减轻集成管理员的合并负担。
* 发版之后，要打 tag 。

# 参考

* 《[分布式 Git](https://git-scm.com/book/zh/v1/%E5%88%86%E5%B8%83%E5%BC%8F-Git)》
* 《[Git-分支-分支的衍合#衍合的风险](https://git-scm.com/book/zh/v1/Git-%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E7%9A%84%E8%A1%8D%E5%90%88#%E8%A1%8D%E5%90%88%E7%9A%84%E9%A3%8E%E9%99%A9)》
* 《[团队开发里频繁使用 git rebase 来保持树的整洁好吗?](http://segmentfault.com/q/1010000000430041)》
* 《[Git 分支管理策略 - 阮一峰](http://www.ruanyifeng.com/blog/2012/07/git.html)》
* 《[Git 分支管理策略 - 廖雪峰](http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013758410364457b9e3d821f4244beb0fd69c61a185ae0000)》