title: "Git 分支管理流程"
date: 2015-08-31 22:31:51
updated: 2015-09-13 22:31:51
tags: Git
---

项目总归要协作开发，在此介绍团队中使用的工作流程。

# 分支管理流程

总结：一个仓库，多个分支。

## 创建特性分支

开发任务的第一个流程是创建特性分支，因为在分支上开发可以让你随意尝试，进退自如，比如碰上无法正常工作的补丁，可以先搁在那边，直到有时间仔细核查修复为止。

那么如何命名分支？可以用相关的主题关键字来命名分支，而且建议把分支名称分置于不同命名空间下，比如 sc/ruby_client 就说明这是 sc 这个人贡献的。 

那么，开始创建第一个分支：

```bash
git checkout -b sc/ruby_client
```

## 定期衍合

开发过程中，建议定期将最新的主干衍合（rebase）到分支，以便获取主干的最新提交记录，并减轻后续合并回主干的成本：

```bash
git pull --rebase origin master
```

解决衍合产生的冲突后，重新强制覆盖远程仓库。

```bash
git push --force origin sc/ruby_client
```

## 决断代码

特性分支开发完成之后，我们想要筛选并看清将要合并到主干的是哪些代码，从而理解它们到底做了些什么，是否真的要并入。可以用 `--not` 选项指定要屏蔽的分支 master，这样就会剔除重复的提交历史：

```bash
$ git log sc/ruby_client --not master
```

或者相反，使用 `..` 参数查看将要被合并到主干的提交：

```bash
$ git log master..sc/ruby_client
```

两者效果一致。

## 合并代码

现在，是时候将分支合并回主干，以便发布新版本了：

```bash
git checkout master
git merge --no-ff sc/ruby_client
```

注意，为了保证版本演进的清晰，分支合并回主干的操作建议加上 `--no-ff` 参数进行非快进式合并（no-fast-forward merge），以便保留合并记录与痕迹！

## 标记新版本

当版本发布之后，标记该新版本，以便后续回滚到指定版本：

```bash
git tag -a v1.0 -m "XX 项目 v1.0 版本"
git push origin v1.0
```

注意，在默认情况下，`git push` 并不会把标签（tag）推送到远端仓库上，只有通过显式命令才能分享标签到远端仓库。其命令格式如同推送分支，运行 `git push origin [tagname]` 即可。如果要一次推送所有本地新增的标签上去，可以使用 `--tags` 选项。

## 删除分支

最后是一些清理工作，删除已开发完成的分支，避免分支越来越多导致不好管理：

```bash
git push --delete origin sc/ruby_client
```

# 指南

最后是一些总结。

## 代码提交指南

* 请不要在更新中提交多余的白字符（whitespace）。Git 有种检查此类问题的方法，在提交之前，先运行 `git diff --check` ，会把可能的多余白字符修正列出来。
* 请将每次提交限定于完成一次逻辑功能。并且可能的话，适当地分解为多次小更新，以便每次小型提交都更易于理解。
* 最后需要谨记的是提交说明的撰写。可以理解为第一行的简要描述将用作邮件标题，其余部分作为邮件正文。

## 分支管理指南

* master 不提交代码，只合并代码。
* 合并代码到 master 的操作，由项目对应的集成管理员负责。
* 各分支要定期将 master 代码合并进来，避免后续分支合并到 master 时容易产生冲突，以减轻集成管理员的合并负担。
* 发版之后，要打 tag 。

# 参考

* 《[分布式 Git](https://git-scm.com/book/zh/v1/%E5%88%86%E5%B8%83%E5%BC%8F-Git)》