---
title: Maven 构建生命周期
date: 2018-05-01 22:47:42
updated:
tags: Java
---

本文用于理顺 Maven 构建的生命周期（Build Lifecycle）概念，掌握执行 Maven 命令时其背后的原理。

# 构建

## 生命周期（Lifecycle）

生命周期（Lifecycle）是一个抽象的概念，意味着它并不做任何实质性的事情，也就是说它像接口，只定义规范，具体细节不管。具体的实现细节则交给了 Maven 各个插件（Plugin）。

生命周期（Lifecycle）是一系列有序的阶段（Phase），而插件的目标（Goal）是跟某个生命周期的阶段绑定在一起的，如果一个阶段没有绑定任何目标，则运行该阶段没有任何实质意义。

摘录一段官方的描述：

> A Build lifecycle is Made Up of build Phases.
>
> A build phase represents a stage in the lifecycle.
>
> A Build Phase is Made Up of Goals.

Maven 内置三种生命周期：

| 内置 Lifecycle | 描述                                     | 内置 Phase 数量 |
| -------------- | ---------------------------------------- | --------------- |
| `clean`        | Project cleaning                         | 3 个            |
| `default`      | Project deployment                       | 23 个           |
| `site`         | Creation of project's site documentation | 4 个            |

## 阶段（Phase）

Phase 虽然很多，但其中带连字符 (`pre-*`, `post-*`, or `process-*`) 的 Phase 通常不会在命令行中直接使用。

那么有哪些常用的 Phase？

| Phase     | 描述                                                         |
| --------- | ------------------------------------------------------------ |
| `clean`   | remove all files generated by the previous build.            |
| `complie` | compile the source code of the project                       |
| `test`    | test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed. |
| `package` | take the compiled code and package it in its distributable format, such as a JAR. |
| `install` | install the package into the local repository, for use as a dependency in other projects locally |
| `deploy`  | done in the build environment, copies the final package to the remote repository for sharing with other developers and projects. |

如何运行一个 Phase？使用命令 `mvn phase`。运行时，首先由该 phase 确定对应的生命周期。然后从生命周期的第一个 Phase 开始，**按顺序**运行到该 phase。

## 目标（Goal）

Phase 是一个逻辑概念，本身并不包含任何构建信息，运行 Phase 时，只是运行绑定到该 Phase 的 Goal。

Plugin 是一个物理概念，安装了 Plugin 才会有相应的一些 Goal。而每个 Goal 代表了该 Plugin 的一种能力。如果要直接运行一个 Goal，可以使用 `mvn <plugin-prefix>:<goal>`。其中 plugin-prefix 的[约定格式](http://maven.apache.org/guides/introduction/introduction-to-plugin-prefix-mapping.html)如下：

| 约定格式                 | 描述                                                         |
| ------------------------ | ------------------------------------------------------------ |
| `maven-${prefix}-plugin` | Apache Maven 团队维护的官方插件。例如 `maven-compiler-plugin`，命令：`mvn dependency:list ` |
| `${prefix}-maven-plugin` | 其它插件。例如 `spring-boot-maven-plugin`，命令：`mvn spring-boot:run` |

# 插件（Plugin）

Maven 本质上是一个插件框架，它的核心并不执行任何具体的构建任务，所有这些任务都交给插件来完成，例如编译源代码是由 `maven-compiler-plugin` 完成的。每个插件会有一个或者多个目标（goal），例如 `maven-compiler-plugin` 插件的 `compile` 目标用来编译位于 `src/main/java/` 目录下的主源码，`testCompile` 目标用来编译位于 `src/test/java/` 目录下的测试源码。

用户可以通过两种方式调用 Maven 插件目标：

1. 将插件目标与生命周期阶段（lifecycle phase）绑定，这样用户在命令行只是输入生命周期阶段而已，例如 Maven 默认将 `maven-compiler-plugin` 的 `compile` 目标与 `compile` 生命周期阶段绑定，因此命令 `mvn compile` 实际上是先定位到 `compile` 这一生命周期阶段，然后再根据绑定关系调用 `maven-compiler-plugin` 的 `compile` 目标。
2. 直接在命令行指定要执行的插件目标（goal），例如 `mvn archetype:generate` 就表示调用 `maven-archetype-plugin` 的 `generate` 目标，**这种带冒号的调用方式与生命周期无关**。

常用插件整理如下：

![Maven 常用插件](/img/java/maven/plugins.png)

## 核心插件

## 打包工具

## 其它工具

### maven-archetype-plugin

用于生成骨架，详见[Maven 骨架快速搭建项目](/2018/12/08/maven-archetype/)。

### maven-dependency-plugin

用于分析项目依赖，例如通过 `mvn dependency:tree` 命令分析 Dubbo 默认依赖的第三方库：

```
[INFO] +- com.alibaba:dubbo:jar:2.5.9-SNAPSHOT:compile
[INFO] |  +- org.springframework:spring-context:jar:4.3.10.RELEASE:compile
[INFO] |  +- org.javassist:javassist:jar:3.21.0-GA:compile
[INFO] |  \- org.jboss.netty:netty:jar:3.2.5.Final:compile
```

## IDEA Maven 插件

最后来看下 IDEA Maven 插件提供的 Maven Projects tool window 功能：

![IDEA Maven Projects](/img/java/idea_maven_projects.png)

# 参考

http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html

http://maven.apache.org/plugins/index.html