title: "git rebase 命令衍合分支"
date: 2015-08-20 22:04:13
updated: 
tags: Git
---

本文介绍一个生僻但推荐使用的命令 `rebase`。

# 使用场景

衍合的两个使用场景：

1. 整理提交历史
2. 生成干净补丁

## 场景一

开发过程中，需要定期将最新的远程分支同步到本地分支，保持代码最新（up to date）。如果同步频繁，使用 `merge` 命令会造成祖先图谱（ancestry graph）无谓的复杂：

```
*   ab900eb - 三方合并版本（注意这里！）
|\
| * 756ba83 - 本地分支提交的版本
* | 915fe84 - 先被推送到远程分支的版本
|/
*   e7ce3f8 - 基准版本（共同祖先）
```

这时会推荐使用 `rebase` 避免无谓的合并节点，从而产生一个更为整洁的提交历史。如果视察一个衍合过的分支的历史记录，看起来会更清楚：仿佛所有修改都是在一根线上先后进行的，尽管实际上它们原本是同时并行发生的。其祖先图谱如下：

```
*   dc6baf3 - 本地分支提交的版本（注意这个提交被改写了！）
|
*   915fe84 - 先被推送到远程分支的版本
|
*   e7ce3f8 - 基准版本（共同祖先）
```

## 场景二

另一个使用衍合的目的，是想要得到一个能在远程分支上干净应用的补丁 — 比如某些项目你不是维护者，但想帮点忙的话，最好用衍合：先在自己的一个分支里进行开发，当准备向主项目提交补丁的时候，根据最新的 `origin/master` 进行一次衍合操作然后再提交，这样维护者就**不需要做任何整合工作**（实际上是把解决分支补丁同最新主干代码之间冲突的责任，化转为由提交补丁的人来解决。），只需根据你提供的仓库地址作一次**快进合并**，或者直接采纳你提交的补丁。

# 使用方法

我们可以在 `pull` 同步时主动进行衍合操作：

```bash
$ git pull --rebase origin cyn/python_cli
```

加上 `--rebase` 的意思是: 

1. 把本地分支从上一次 `pull` 之后的变更暂存起来；
2. 恢复到上一次 `pull` 时的情况；
3. 合并远程分支的提交；
4. 最后再逐一合并刚暂存下来的本地提交（相当于重放一遍）。

解决衍合产生的冲突之后，推送回远程仓库：

```bash
$ git push origin cyn/python_cli
```

# 使用风险

衍合必须遵守的准则：**一旦本地分支中的提交（commit）已经被推送到远程仓库，就千万不要对该分支进行衍合操作。**如果把衍合当成一种**在推送之前**整理提交历史的手段，而且仅仅衍合那些**尚未推送**的本地提交，就没问题。如果衍合那些已经推送的提交，并且已经有人基于这些提交对象开展了后续开发工作的话，就会出现叫人沮丧的麻烦。

# 参考

* 《[Git-分支-分支的衍合#衍合的风险](https://git-scm.com/book/zh/v1/Git-%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E7%9A%84%E8%A1%8D%E5%90%88#%E8%A1%8D%E5%90%88%E7%9A%84%E9%A3%8E%E9%99%A9)》
* 《[团队开发里频繁使用 git rebase 来保持树的整洁好吗?](http://segmentfault.com/q/1010000000430041)》