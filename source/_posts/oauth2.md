---
title: OAuth 2.0 四种授权方式总结
date: 2017-11-11 22:16:13
updated:
tags: 安全
---

OAuth 2.0 定义了四种授权方式。

- 授权码模式（authorization code）
- 简化模式（implicit）
- 密码模式（resource owner password credentials）
- 客户端模式（client credentials）

四种授权方式各有利弊，都有其对应的应用场景，但目的都是为了获得令牌。下表总结了各种授权方式下，申请 `access_token` 令牌的前置条件：

| 授权方式   | 授权的前置条件   | grant_type           | 描述                                                         |
| ---------- | ---------------- | -------------------- | ------------------------------------------------------------ |
| 授权码模式 | 授权码           | `authorization_code` | 这种模式是功能最完整、流程最严密的授权模式，第三方应用需要先获取**授权码**，才能申请到令牌。它的特点就是通过第三方应用的后台服务器，与“服务提供商”的认证服务器进行互动，通过授权码换令牌，**第三方应用不接触用户密码，安全性高**。 |
| 密码模式   | 用户的账号、密码 | `password`           | 在这种模式下，用户必须把自己的**用户名和密码**发给第三方应用，第三方应用使用这些信息，向“服务提供商”索要授权。其风险在于第三方应用获知了密码。这通常用在用户对其高度信任的情况下，或者所有服务都由同一家公司提供。 |
| 客户端模式 | 无               | `client_credentials` | 第三方应用以自己的名义，而不是以用户的名义，向“服务提供商”进行认证。 |

密码模式还有一种主流的变种，即使用**用户手机号和短信验证码**申请令牌，相比密码模式会更安全些。为了区分，可以自定义一个 `grant_type` 为 `sms_verify_code`。

# 授权码模式

手绘了一张图重点总结下授权码模式的整个流程：

![OAuth 2.0 授权码模式](/img/security/oauth2.png)

交互方式上特别注意浏览器会进行几次 302 重定向。流程总结如下：

1. 第三方应用首先向服务提供商申请 `client_id` 应用唯一标识、`client_secret` 密钥；
2. 用户首次授权会 302 重定向到认证服务器：此时要提供预分配好的 `client_id` 标识来源，提供 `scope` 标识要申请的权限，提供 `redirect_uri` 标识授权完毕后要回跳的第三方应用的链接。
3. 第二次 302 重定向：认证服务器展示登录页。
4. 第三次 302 重定向：在用户提交授权，认证服务器认证成功后，会分配授权码 `code`，并重定向回第三方应用的 `redirect_uri` 。
5. 最后，第三方应用会向认证服务器申请令牌 `access_token`，此时要提供预分配好的 `code`、`client_id`、`client_secret` 以便认证。这一步是在后端之间完成的，对用户不可见。
6. `access_token` 是有有效期的，过期后需要刷新。
7. 拿到令牌 `access_token` 后，第三方应用就可以访问资源方，获取所需资源。

# 参考

https://oauth.net/2/
https://developer.linkedin.com/zh-cn/docs/oauth2
http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html