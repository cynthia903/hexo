---
title: Git 分支模型实践
date: 2016-04-05 08:48:24
updated:
tags: Git
---

续[上文](/2016/04/03/git-branch/)。

有了一套成熟的分支模型以及相应的权限控制之后，接下来我们以一个例子来演示如何实践这套流程。

# 分支模型实践

## 创建特性分支

首先，从 `dev` 分支中创建出特性分支：

```bash
$ git checkout -b feature-cache

do something and commit...

$ git push origin feature-cache
```

### 定期合并

由于特性分支可能会跨版本开发，因此需要定期维护：主要的工作就是将 `dev` 分支合并（`merge`）回来，保持同步。

### 决断代码

特性分支开发完成之后，我们想要筛选并看清将要合并到主干的提交有哪些，可以参考[这里](/2015/08/04/git-log/#筛选提交历史)。

## 合并特性分支

现在，是时候将分支合并回主干，以便发布新版本了：

```bash
$ git checkout master
$ git merge --no-ff feature-cache
```

注意，为了保证版本演进的清晰，分支合并回主干的操作建议加上 `--no-ff` 参数进行非快进式合并（no-fast-forward merge），以便保留合并痕迹。合并后的祖先图谱如下：

```
*   ab900eb - 合并版本（注意这里！）
|\
| * 756ba83 - 特性分支版本2
| * 915fe84 - 特性分支版本1
|/
*   e7ce3f8 - master 基准版本（祖先）
```

可以看见，合并后保留有分支历史痕迹，能看得出来曾经做过分支合并。为了保证版本演进的清晰，当分支合并到主干时，推荐使用！

同时作为对比，如果不加上 `--no-ff` 参数，合并后的祖先图谱如下：

```
*   756ba83 - 特性分支版本2（SHA-1 不变）
|
*   915fe84 - 特性分支版本1（SHA-1 不变）
|
*   e7ce3f8 - master 基准版本（祖先）
```

那么，究竟什么是快进式合并（fast-forward merge）？如果顺着一个分支走下去可以直接到达另一个分支的话，那么 Git 在合并两者时，只会简单地把指针右移，因为这种单线的历史分支不存在任何需要解决的分歧，所以这种合并过程可以称为快进（Fast forward））。

## 标记新版本

版本发布之后，应该标记该新版本，以便后续回顾：

```bash
$ git tag v1.0 -m "XX 项目 v1.0 版本"
$ git push origin v1.0
```

注意，在默认情况下，`git push` 并不会把标签（tag）推送到远端仓库上，只有通过显式命令才能分享标签到远端仓库。其命令格式如同推送分支，运行 `git push origin [tagname]` 即可。如果要一次推送所有本地新增的标签上去，可以使用 `--tags` 选项。

## 删除特性分支

最后是一些清理工作，删除已开发完成的分支，避免分支越来越多导致不好管理：

```bash
$ git branch -d feature-cache
$ git push --delete origin feature-cache
```

# 总结

## 代码提交指南

* 请不要在更新中提交多余的白字符（whitespace）。Git 有种检查此类问题的方法，在提交之前，先运行 `git diff --check` ，会把可能的多余白字符修正列出来。
* 请将每次提交限定于完成一次逻辑功能。并且可能的话，适当地分解为多次小更新，以便每次小型提交都更易于理解。
* 最后需要谨记的是提交说明的撰写。可以理解为第一行的简要描述将用作邮件标题，其余部分作为邮件正文。

## 分支管理指南

* master 不提交代码，只合并代码。
* 合并代码到 master 的操作，由项目对应的集成管理员专人负责。
* 各分支要定期将 master 代码合并进来，避免后续分支合并到 master 时容易产生冲突，以减轻集成管理员的合并负担。
* 发版之后，要打 tag 。

# 参考

* 《[分布式 Git](https://git-scm.com/book/zh/v1/%E5%88%86%E5%B8%83%E5%BC%8F-Git)》
* 《[Git 分支管理策略 - 廖雪峰](http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013758410364457b9e3d821f4244beb0fd69c61a185ae0000)》